# Language / Idioma
- [English](#english)
- [Portugu√™s-BR](#portugu√™s-br)

---
---

# English

# Temporal Naive Bayes (TNB) for Autonomous Navigation

This repository implements an adaptation of the classic Naive Bayes for sequential data, called **Temporal Naive Bayes (TNB)**, applied to anomaly detection and multi-class classification using IMU signals in CARLA simulations.

---

## üìã Table of Contents

- [1. Overview](#1-overview)  
- [2. Mathematical Foundations](#2-mathematical-foundations)  
  - 2.1. Classic Naive Bayes  
  - 2.2. Temporal Naive Bayes  
  - 2.3. AR(1) Model and MLE  
- [3. Experimental Pipeline](#3-experimental-pipeline)  
  - 3.1. Synthetic Data Generation  
  - 3.2. Offline Data Collection in CARLA  
  - 3.3. Automatic Labeling  
  - 3.4. Offline Parameter Estimation  
  - 3.5. Real-Time Integration  
  - 3.6. Multi-Class Classification  
- [4. Folder Structure](#4-folder-structure)  
- [5. Installation & Dependencies](#5-installation--dependencies)  
- [6. Running the Scripts](#6-running-the-scripts)  
- [7. Usage Examples](#7-usage-examples)  
- [8. Publication](#8-publication)

---

## 1. Overview

Detecting anomalies and classifying maneuvers in autonomous robots/vehicles requires handling the **temporal dependency** in sensor data. Classic **Naive Bayes** assumes feature independence, which breaks down for time series. In TNB we model each reading conditional on the previous one using a **first-order autoregressive (AR(1))** model.

---

## 2. Mathematical Foundations

### 2.1. Classic Naive Bayes

For classification into classes \(C\):


$$P(C \mid X)
\;\propto\;
P(C)\,\prod_{i=1}^n P(x_i \mid C)$$


### 2.2. Temporal Naive Bayes (TNB)

We incorporate first-order dependence between sequential readings:

$$
P(C \mid X_{1:T})
\;\propto\;
P(C)\,\prod_{t=2}^T
P\bigl(x_t \mid C,\,x_{t-1}\bigr)
$$


### 2.3. AR(1) Model and Maximum Likelihood Estimation

We model each acceleration-magnitude window $x_t$ as:


$$x_t = \mu + \alpha\,x_{t-1} + \varepsilon_t,
\quad
\varepsilon_t \sim \mathcal{N}(0,\sigma^2).$$


The likelihood for a window $x_1,\dots,x_T$ is:

$$\mathcal{L}(\mu,\alpha,\sigma)
=\prod_{t=2}^T\frac{1}{\sigma\sqrt{2\pi}}
\exp\Bigl[-\frac{(x_t-\mu-\alpha x_{t-1})^2}{2\sigma^2}\Bigr].$$

Maximizing this yields the MLE estimates:
1. $\displaystyle \hat\alpha
= \frac{\sum_{t=2}^T (x_t-\mu)\,x_{t-1}}
       {\sum_{t=2}^T x_{t-1}^2}$
2. $\displaystyle \hat\mu
= \frac{1}{T-1}\sum_{t=2}^T (x_t - \hat\alpha\,x_{t-1})$
3. $\displaystyle \hat\sigma
= \sqrt{\frac{1}{T-1}
\sum_{t=2}^T (x_t - \hat\mu - \hat\alpha x_{t-1})^2}$

The code implements these steps iteratively in the `estimate_parameters` function.

---

## 3. Experimental Pipeline

### 3.1. Synthetic Data Generation
- Simulate AR(1) series with different parameters for two classes.
- Evaluate accuracy sensitivity versus $\alpha$ and $\sigma$.

**Note:** Synthetic analysis notebooks are in `notebooks/`:  
`Ideal_Synthetic_TNB.ipynb` and `Realistic_Synthetic_TNB.ipynb`.

### 3.2. Offline Data Collection in CARLA
- Run CARLA in synchronous mode, collect IMU and vehicle control.
- Save `.npz` containing:
  - `timestamp`, `accelerometer`, `gyroscope`, `compass`
  - `throttle`, `steer`, `brake`

### 3.3. Automatic Labeling
`auto_label.py` reads control signals and labels each frame:
- `brake` if `brake > Œ∏_b`
- `turn` if `|steer| > Œ∏_s`
- `cruise` if `throttle > Œ∏_t`
- `idle` otherwise

Generates a reproducible `labels.csv`.

### 3.4. Offline Parameter Estimation
`parameter_estimation.py`:
1. Loads `labels.csv` and IMU windows.
2. Slides fixed-size windows, assigns label by **majority vote**.
3. Estimates $(\mu_k,\sigma_k,\alpha_k)$ per class via MLE + Cross-Validation.
4. Saves `class_params.json` with parameters and priors.

### 3.5. Real-Time Integration
`real_time_multiclass.py`:
1. Loads `class_params.json`.
2. Collects IMU into a sliding buffer.
3. Estimates parameters for the current window.
4. Computes log-likelihood for each class:

```math
   \ell_k(X)
   = -\sum_{t=2}^T
     \frac{(x_t-\mu_k-\alpha_k x_{t-1})^2}{2\sigma_k^2}
     - (T-1)\ln(\sigma_k\sqrt{2\pi})
     + \ln P(C_k).
```

5. Classifies $\hat k = \arg\max_k \ell_k(X)$.
6. Displays prediction on a Pygame dashboard + Matplotlib plots.

### 3.6. Multi-Class Classification
- Supported classes: `idle`, `cruise`, `turn`, `brake`.
- Easily extendable to other maneuvers.

---

## 4. Folder Structure
```bash
‚îú‚îÄ‚îÄ TNB-Autonomous-Navigation/
      ‚îú‚îÄ‚îÄ carla_validation/
      ‚îÇ      ‚îú‚îÄ‚îÄ data/
      ‚îÇ      ‚îú‚îÄ‚îÄ multiclass_detection/
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ data/
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ auto_label.py
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ class_params.json
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ multiclass_detection.py
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ parameter_estimation.py
      ‚îÇ      ‚îÇ      ‚îî‚îÄ‚îÄ real_time_multiclass.py                  
      ‚îÇ      ‚îú‚îÄ‚îÄ data_collection.py
      ‚îÇ      ‚îú‚îÄ‚îÄ offline_processing_imu.py
      ‚îÇ      ‚îú‚îÄ‚îÄ plot_imu_data.py
      ‚îÇ      ‚îú‚îÄ‚îÄ real_time_tnb_integration.py
      ‚îÇ      ‚îî‚îÄ‚îÄ t_nb_offline_analysis.py
      ‚îî‚îÄ‚îÄ notebooks/
            ‚îú‚îÄ‚îÄ Ideal_Synthetic_TNB.ipynb
            ‚îî‚îÄ‚îÄ Realistic_Synthetic_TNB.ipynb
```

---

## 5. Installation & Dependencies
```bash
# (Optional) create virtual environment
conda create -n tnb python=3.8
conda activate tnb

# Install required packages
pip install numpy scipy scikit-learn pygame matplotlib python-pptx carla
```
**Note:** Ensure the CARLA server is running on `localhost:2000`.


---

## 6. Running the Scripts

### 6.1 Offline Data Collection
```bash
python multiclass_detection/data_collection.py
```

### 6.2 Automatic Labeling
```bash
python multiclass_detection/auto_label.py
```

### 6.3 Parameter Estimation
```bash
python multiclass_detection/parameter_estimation.py
```

### 6.4 Real-Time Multi-Class Demo
```bash
python multiclass_detection/real_time_multiclass.py
```

---

## 7. Usage Examples

- Adjust thresholds in `auto_label.py` for different scenarios.

- Tweak `WINDOW_SIZE` and `KFOLDS` in `parameter_estimation.py` to optimize performance.

- Record the Pygame dashboard in `real_time_multiclass.py` for demonstrations.

---

## 8. Publication

-  Papers and further publication details are **in progress**.

---
---

# Portugu√™s-BR

# Temporal Naive Bayes (TNB) para Navega√ß√£o Aut√¥noma

Este reposit√≥rio implementa uma adapta√ß√£o do Naive Bayes cl√°ssico para dados sequenciais, denominada **Temporal Naive Bayes (TNB)**, aplicada √† detec√ß√£o de anomalias e classifica√ß√£o multiclasse usando sinais de IMU em simula√ß√µes no CARLA.

---

## üìã Sum√°rio

- [1. Vis√£o Geral](#1-vis√£o-geral)  
- [2. Fundamentos Matem√°ticos](#2-fundamentos-matem√°ticos)  
  - 2.1. Naive Bayes Cl√°ssico  
  - 2.2. Temporal Naive Bayes  
  - 2.3. Modelo AR(1) e MLE  
- [3. Pipeline de Experimenta√ß√£o](#3-pipeline-de-experimenta√ß√£o)  
  - 3.1. Gera√ß√£o de Dados Sint√©ticos  
  - 3.2. Coleta Offline no CARLA  
  - 3.3. Rotulagem Autom√°tica  
  - 3.4. Estima√ß√£o Offline de Par√¢metros  
  - 3.5. Integra√ß√£o em Tempo Real  
  - 3.6. Classifica√ß√£o Multiclasse  
- [4. Estrutura de Pastas](#4-estrutura-de-pastas)  
- [5. Instala√ß√£o e Depend√™ncias](#5-instala√ß√£o-e-depend√™ncias)  
- [6. Execu√ß√£o dos Scripts](#6-execu√ß√£o-dos-scripts)  
- [7. Exemplos de Uso](#7-exemplos-de-uso)  
- [8. Publica√ß√£o](#8-publica√ß√£o)

---

## 1. Vis√£o Geral

Detec√ß√£o de anomalias e classifica√ß√£o de manobras em rob√¥s/carros aut√¥nomos requer o tratamento da **depend√™ncia temporal** nos dados de sensores. O **Naive Bayes** cl√°ssico assume independ√™ncia entre as features, o que falha para s√©ries temporais. No TNB, modelamos cada leitura condicionalmente √† anterior, usando um **modelo autorregressivo de primeira ordem (AR(1))**.

---

## 2. Fundamentos Matem√°ticos

### 2.1. Naive Bayes Cl√°ssico

Para classifica√ß√£o em classes $C$:

$$P(C \mid X) \;\propto\; P(C)\,\prod_{i=1}^n P(x_i \mid C)$$


### 2.2. Temporal Naive Bayes (TNB)

Incorporamos depend√™ncia de primeira ordem entre leituras sequenciais:

$$P(C \mid X_{1:T}) \;\propto\; P(C)\,\prod_{t=2}^T P\bigl(x_t \mid C,\, x_{t-1}\bigr)$$


### 2.3. Modelo AR(1) e Estima√ß√£o MLE

Modelamos cada janela de magnitude de acelera√ß√£o $x_t$ como:

$$x_t = \mu + \alpha\,x_{t-1} + \varepsilon_t,\quad \varepsilon_t\sim\mathcal{N}(0,\sigma^2).$$


A fun√ß√£o de verossimilhan√ßa para uma janela $x_1,\dots,x_T$ √©:

$$\mathcal{L}(\mu,\alpha,\sigma)
=\prod_{t=2}^T\frac{1}{\sigma\sqrt{2\pi}}
\exp\Bigl[-\frac{(x_t-\mu-\alpha x_{t-1})^2}{2\sigma^2}\Bigr].$$


Maximizando esta fun√ß√£o obt√™m-se as estimativas (MLE):
1. $\displaystyle \hat\alpha = \frac{\sum_{t=2}^T (x_t-\mu)\,x_{t-1}}{\sum_{t=2}^T x_{t-1}^2}$  
2. $\displaystyle \hat\mu = \frac{1}{T-1}\sum_{t=2}^T (x_t - \hat\alpha\,x_{t-1}) $
3. $\displaystyle \hat\sigma = \sqrt{\frac{1}{T-1}\sum_{t=2}^T (x_t - \hat\mu - \hat\alpha x_{t-1})^2}$

O c√≥digo implementa estas etapas iterativamente (fun√ß√£o `estimate_parameters`).

---

## 3. Pipeline de Experimenta√ß√£o

### 3.1. Gera√ß√£o de Dados Sint√©ticos
- Simula s√©ries AR(1) com par√¢metros distintos para duas classes.
- Avalia sensibilidade de acur√°cia vs. $\alpha$ e $\sigma$.

**Nota:** As an√°lises feitas com dados sint√©ticos podem ser vistas e reproduzidas nos arquivos da pasta `notebooks/`: `Ideal_Synthetic_TNB.ipynb` e `Realistic_Synthetic_TNB.ipynb`.

### 3.2. Coleta Offline no CARLA
- Executa simula√ß√£o em modo s√≠ncrono, coleta IMU e controle do ve√≠culo.
- Salva `.npz` com:
  - `timestamp`, `accelerometer`, `gyroscope`, `compass`
  - `throttle`, `steer`, `brake`

### 3.3. Rotulagem Autom√°tica
Script `auto_label.py` l√™ controles e classifica cada frame:
- `brake` se `brake > Œ∏_b`
- `turn` se `|steer| > Œ∏_s`
- `cruise` se `throttle > Œ∏_t`
- `idle` caso contr√°rio

Gera `labels.csv` de forma reprodut√≠vel.

### 3.4. Estima√ß√£o Offline de Par√¢metros
Script `parameter_estimation.py`:
1. Carrega `labels.csv` e janelas de IMU.
2. Desliza janelas de tamanho fixo e atribui label pela **maioria**.
3. Estima $(\mu_k,\sigma_k,\alpha_k)$ por classe via MLE + Valida√ß√£o Cruzada.
4. Salva `class_params.json` com par√¢metros e priors.

### 3.5. Integra√ß√£o em Tempo Real
Script `real_time_multiclass.py`:
1. Carrega `class_params.json`.
2. Coleta IMU + buffer deslizante.
3. Estima par√¢metros da janela corrente.
4. Calcula log-verossimilhan√ßa para cada classe:

```math
\ell_k(X)= -\sum_{t=2}^T\frac{(x_t-\mu_k-\alpha_k x_{t-1})^2}{2\sigma_k^2} - (T-1)\ln(\sigma_k\sqrt{2\pi})
+ \ln P(C_k).
```
5. Classifica $\hat k=\arg\max_k \ell_k(X)$.
6. Exibe predi√ß√£o em painel Pygame + gr√°ficos Matplotlib.

### 3.6. Classifica√ß√£o Multiclasse
- Classes: `idle`, `cruise`, `turn`, `brake`
- F√°cil extens√£o para novas classes/manobras.

---

## 4. Estrutura de Pastas
```bash
‚îú‚îÄ‚îÄ TNB-Autonomous-Navigation/
      ‚îú‚îÄ‚îÄ carla_validation/
      ‚îÇ      ‚îú‚îÄ‚îÄ data/
      ‚îÇ      ‚îú‚îÄ‚îÄ multiclass_detection/
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ data/
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ auto_label.py
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ class_params.json
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ multiclass_detection.py
      ‚îÇ      ‚îÇ      ‚îú‚îÄ‚îÄ parameter_estimation.py
      ‚îÇ      ‚îÇ      ‚îî‚îÄ‚îÄ real_time_multiclass.py                  
      ‚îÇ      ‚îú‚îÄ‚îÄ data_collection.py
      ‚îÇ      ‚îú‚îÄ‚îÄ offline_processing_imu.py
      ‚îÇ      ‚îú‚îÄ‚îÄ plot_imu_data.py
      ‚îÇ      ‚îú‚îÄ‚îÄ real_time_tnb_integration.py
      ‚îÇ      ‚îî‚îÄ‚îÄ t_nb_offline_analysis.py
      ‚îî‚îÄ‚îÄ notebooks/
            ‚îú‚îÄ‚îÄ Ideal_Synthetic_TNB.ipynb
            ‚îî‚îÄ‚îÄ Realistic_Synthetic_TNB.ipynb
```

---

## 5. Instala√ß√£o e Depend√™ncias
```bash
# Ambiente virtual opcional
conda create -n tnb python=3.8
conda activate tnb

# Instala√ß√£o de pacotes
pip install numpy scipy scikit-learn pygame matplotlib python-pptx carla
```
**Nota:** Certifique-se de que o servidor CARLA esteja rodando em `localhost:2000`.

---

## 6. Execu√ß√£o dos Scripts

### 6.1 Coleta de Dados (Offline)
```bash
python multiclass_detection/data_collection.py
```

### 6.2 Rotulagem Autom√°tica
```bash
python multiclass_detection/auto_label.py
```

### 6.3 Estimativa de Par√¢metros
```bash
python multiclass_detection/parameter_estimation.py
```

### 6.4 Demo Real-Time Multiclasse
```bash
python multiclass_detection/real_time_multiclass.py
```

---

## 7. Exemplos de Uso

- Ajuste thresholds em `auto_label.py` para cen√°rios variados.

- Modifique `WINDOW_SIZE` e `KFOLDS` em `parameter_estimation.py` para otimiza√ß√£o.

- Use `real_time_multiclass.py` para capturar v√≠deos do painel e demonstrar resultados.

---

## 8. Publica√ß√£o

-  Artigos Publicados: **EM DESENVOLVIMENTO**.
